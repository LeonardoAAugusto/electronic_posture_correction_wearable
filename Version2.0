#include <Wire.h>
#include <MPU6050_tockn.h>

MPU6050 mpu(Wire);

const int buzzer = 9;

// LIMITES
float LIMITE_FRENTE = 35;
float LIMITE_TRAS   = -35;
float LIMITE_LADO   = 30;
float LIMITE_QUEDA  = 70;
float LIMITE_TORCAO = 120;

void setup() {
  Serial.begin(19200);
  Wire.begin();

  mpu.begin();
  mpu.calcGyroOffsets(true);  // calibração automática

  pinMode(buzzer, OUTPUT);
  digitalWrite(buzzer, LOW);

  Serial.println("=== SISTEMA INICIADO ===");
}

void beepAlerta() {
  tone(buzzer, 700, 120);
  delay(10);
}

void loop() {
  mpu.update();

  float pitch = mpu.getAngleX(); // inclinação frente/trás
  float roll  = mpu.getAngleY(); // inclinação lateral
  float yaw   = mpu.getAngleZ();
  float gyroZ = mpu.getGyroZ();

  Serial.print("Pitch: "); Serial.print(pitch);
  Serial.print(" | Roll: "); Serial.print(roll);
  Serial.print(" | Yaw: "); Serial.print(yaw);
  Serial.print(" | GyZ: "); Serial.println(gyroZ);

  bool detectou = false;

  // ====== DETECÇÃO ======

  // QUEDA
  if (abs(pitch) > LIMITE_QUEDA || abs(roll) > LIMITE_QUEDA) {
    Serial.println("DETECÇÃO: QUEDA");
    beepAlerta();
    detectou = true;
  }

  // FRENTE
  if (pitch > LIMITE_FRENTE) {
    Serial.println("DETECÇÃO: FRENTE");
    beepAlerta();
    detectou = true;
  }

  // TRÁS
  if (pitch < LIMITE_TRAS) {
    Serial.println("DETECÇÃO: TRAS");
    beepAlerta();
    detectou = true;
  }

  // LATERAL
  if (roll > LIMITE_LADO) {
    Serial.println("DETECÇÃO: LATERAL (ESQUERDA)");
    beepAlerta();
    detectou = true;
  }

  if (roll < -LIMITE_LADO) {
    Serial.println("DETECÇÃO: LATERAL (DIREITA)");
    beepAlerta();
    detectou = true;
  }

  // TORÇÃO
  if (abs(gyroZ) > LIMITE_TORCAO) {
    Serial.println("DETECÇÃO: TORÇÃO");
    beepAlerta();
    detectou = true;
  }

  if (!detectou) {
    digitalWrite(buzzer, LOW);
  }

  delay(50);
}
